name: Release Pipeline

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  create-assets:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify application
      run: |
        echo "Verifying Secure File Vault ${{ github.ref_name }}"
        python -c "
        import sys
        sys.path.insert(0, 'src')
        try:
            from secure_file_vault.main import main
            print('✅ Application imports correctly')
        except Exception as e:
            print(f'❌ Error: {e}')
            sys.exit(1)
        "
    
    - name: Create source code zip
      run: |
        # Create clean source zip
        zip -r SecureFileVault-${{ github.ref_name }}-source.zip . \
          -x "*.git*" "*.pyc" "__pycache__/*" ".github/*" ".vscode/*" "*.vault" "*.key" "*.pem"
        echo "Created: SecureFileVault-${{ github.ref_name }}-source.zip"
    
    - name: Create standalone executable (Windows)
      if: startsWith(github.ref, 'v2.')
      run: |
        echo "Creating Windows executable..."
        pip install pyinstaller
        pyinstaller --onefile --name="SecureFileVault" main.py
        cd dist
        zip ../SecureFileVault-Windows-${{ github.ref_name }}.zip SecureFileVault.exe
        cd ..
        echo "Created Windows executable"
    
    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          SecureFileVault-*-source.zip
          SecureFileVault-Windows-*.zip
        draft: false
        prerelease: false
